name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  build_and_test:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Test Job
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_AZURE_FUNCTION_URL: ${{ secrets.VITE_AZURE_FUNCTION_URL }}

      - name: Build Success
        run: |
          echo "‚úÖ Application built successfully!"
          echo "üìÅ Build output available in dist/ directory"
          echo "üìã Build contains:"
          ls -la dist/
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-files
          path: dist/
          
      - name: Deployment Instructions
        run: |
          echo "üöÄ DEPLOYMENT INSTRUCTIONS:"
          echo "================================"
          echo "To deploy to Azure Static Web Apps, you need to add the deployment token:"
          echo ""
          echo "1. Go to Azure Portal ‚Üí Static Web Apps"
          echo "2. Select your app: swa-sharepoint-prod-001"  
          echo "3. Go to 'Overview' ‚Üí 'Manage deployment token'"
          echo "4. Copy the token"
          echo "5. Go to GitHub repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "6. Click 'New repository secret'"
          echo "7. Name: AZURE_STATIC_WEB_APPS_API_TOKEN"
          echo "8. Value: <paste the deployment token>"
          echo "9. Save the secret"
          echo ""
          echo "After adding the secret, this workflow will automatically deploy to Azure!"
          echo "================================"

  # Optional: Deploy job that runs only if token is available
  deploy_to_azure:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && vars.AZURE_DEPLOYMENT_ENABLED == 'true'
    needs: build_and_test
    runs-on: ubuntu-latest
    name: Deploy to Azure Static Web Apps
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-files
          path: dist/

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          output_location: "dist"
          skip_app_build: true  # Use pre-built artifacts